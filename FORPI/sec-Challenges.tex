
\section{First-Order Challenges}\label{sec:Challenges}


In this section, we describe challenges that have to be overcome in order to successfully adapt {\RPI} to the first-order case. The first example illustrates the need to take unification into account. The other two examples discuss complex issues that can arise when unification is taken into account in a naive way.

%straightforward example
\begin{example}\label{ex:unif} 
Consider the following proof $\psi$. When computed as in the propositional case, the safe literals for $\eta_3$ are $\{ q(c), ~ p(a,X)\}$.
%$\eta_1$'s literal is unifiable with $p(a,X)$, which is inherited from $\eta_3$'s safe literals. 
%Thus the proof can be regularized by recycling $\eta_1$.
%$\eta_1$ and $\eta_5$ and these two literals are unifiable. Further, the safe literals for $\eta_1$ includes $\eta_5$. Thus the proof can be regularized by recycling $\eta_1$.

\begin{scriptsize}
\begin{prooftree}
\def\e{\mbox{\ $\vdash$\ }}
\AxiomC{$\eta_6$: $p(Y,b)$ \e \hspace{-2cm}}
\AxiomC{$\eta_1$: \e $p(W,X)$}
\AxiomC{$\eta_2$: $p(W,X)$ \e $q(c)$}
\BinaryInfC{$\eta_3$: \e $q(c)$  \hspace{-1.5cm}}
\AxiomC{$\eta_4$: $q(c)$ \e $p(a,X)$}
\BinaryInfC{$\eta_5$: \e $p(a,X)$}
\BinaryInfC{$\psi$: $\bot$}
\end{prooftree}
\end{scriptsize}

\noindent
As neither of $\eta_3$'s pivots is syntactically equal to a safe literal, the propositional {\RPI} algorithm would not change $\psi$. However, $\eta_3$'s left pivot $p(W,X)\in \eta_1$ is unifiable with the safe literal $p(a,X)$. Regularizing $\eta_3$, by deleting the edge between $\eta_2$ and $\eta_3$ and replacing $\eta_3$ by $\eta_1$, leads to further deletion of $\eta_4$ (because it is not resolvable with $\eta_1$) and finally to the much shorter proof below.

\begin{footnotesize}
\begin{prooftree}
\def\e{\mbox{\ $\vdash$\ }}
\AxiomC{$\eta_1$: \e$p(W,X)$}
\AxiomC{$\eta_6$: $p(Y,b)$\e}
\BinaryInfC{$\psi'$: $\bot$}
\end{prooftree}
\end{footnotesize}

\end{example}

\noindent
Unlike in the propositional case, where a pivot must be syntactically equal to a safe literal for regularization to be possible, the example above suggests that, in the first-order case, it might suffice that a pivot be unifiable with a safe literal. However, there are cases, as shown in the example below, where mere unifiability is not enough and greater care is needed.

%unification necessary example
\begin{example}\label{ex:pairwise}

Again, the safe literals for $\eta_3$, when computed as in the propositional case, are $\{q(c), ~ p(a,X)\}$, and as the pivot $p(a,c)$ is unifiable with the safe literal $p(a,X)$, $\eta_3$ appears to be a candidate for regularization. 

\begin{scriptsize}
\begin{prooftree}
\def\e{\mbox{\ $\vdash$\ }}
\AxiomC{$\eta_6$: $p(Y,b)$ \e \hspace{-2cm}}
\AxiomC{$\eta_1$: \e $p(a,c)$}
\AxiomC{$\eta_2$: $p(a,c)$ \e $q(c)$}
\BinaryInfC{$\eta_3$: \e $q(c)$}
\AxiomC{$\eta_4$: $q(c)$ \e $p(a,X)$}
\BinaryInfC{$\eta_5$: \e $p(a,X)$}
\BinaryInfC{$\psi$: $\bot$}
\end{prooftree}
\end{scriptsize}

\begin{figure*}
\begin{small}
\begin{prooftree}
\def\e{\mbox{\ $\vdash$\ }}
\AxiomC{$\eta_8$: $q(f(a,e),c)\e$}
\AxiomC{$\eta_6$: $\e p(c,d)$ \hspace{-2cm}}
\AxiomC{$\eta_1$: $p(U,V)\e q(f(a,V),U)$}
\AxiomC{$\eta_2$: $q(f(a,X),Y),q(T,X)\e q(f(a,Z),Y)$}
\BinaryInfC{$\eta_3$: $p(U,V),q(T,V)\e q(f(a,Z),U)$}
\AxiomC{\hspace{-1cm} $\eta_4$: $\e q(R,S)$}
\BinaryInfC{$\eta_5$: $p(U,V)\e q(f(a,Z),U)$}
\BinaryInfC{$\eta_7$: $\e q(f(a,Z),c)$}
\BinaryInfC{$\psi$: $\bot$}
\end{prooftree}
\end{small}
\caption{An example where pre-regularization unifiability is not sufficient.}
\label{fig:ex-unifcheck}
\end{figure*}

\noindent
However, if we attempt to regularize the proof, the same series of actions as in Example \ref{ex:unif} would 
require resolution between $\eta_1$ and $\eta_6$, which is not possible.
%result in the following resolution, which cannot be completed.
%\begin{footnotesize}
%\begin{prooftree}
%\def\e{\mbox{\ $\vdash$\ }}
%\AxiomC{$\eta_1$: \e$p(a,c)$}
%\AxiomC{$\eta_6$: $p(Y,b)$\e}
%\BinaryInfC{$\psi'$: ??}
%\end{prooftree}
%\end{footnotesize}

\end{example}

\noindent
One way to prevent the problem depicted above would be to require the pivot to be not only unifiable but in fact more general than a safe literal. A weaker (and better) requirement is possible, however, as defined below.

%old - kept for reference/readability.
%\begin{definition}
%\label{prop:pair}
%Let $\eta$ be a node with safe literals $\mathcal{S}(\eta)$ such that resolved literal $\ell'$ is unifiable with a safe literal $\ell \in \mathcal{S}(\eta)$ where $\ell'$ is resolved against literals $\ell_1$, \ldots, $\ell_n$ in a proof $\psi$. The node $\eta$ is said to satisfy the \emph{pre-regularization unifiability property} in $\psi$ if $\ell_1$,\ldots,$\ell_n$, and $\dual{\ell'}$ are unifiable.
%\end{definition}

\begin{definition}
\label{prop:pair}
Let $\eta$ be a node with safe literals $\mathcal{S}(\eta)$ and parents $\eta_1$ and $\eta_2$, assuming without loss of generality, $\eta_2 \xrightarrow[\sigma_2]{\{\ell_2\} } \eta$ such that $\ell_2$ is unifiable with a safe literal $\ell \in \mathcal{S}(\eta)$. 
%Let $\mathcal{P}(\eta)$ (resp. $\mathcal{R}(\eta)$) be the set of all nodes $\eta_1$ (resp. resolved literals $\ell_1$) such that $\eta_2 \xrightarrow[\sigma_2]{\{\ell_2\} } \eta'$ and $\eta_1 \xrightarrow[\sigma_1]{\{\ell_1\} } \eta'$ for some $\eta'$.
Let $\mathcal{R}(\eta)$ be the set of all resolved literals $\ell_1$ such that $\eta_2 \xrightarrow[\sigma_2]{\{\ell_2\} } \eta'$ and $\eta_1 \xrightarrow[\sigma_1]{\{\ell_1\} } \eta'$ for some $\eta_1$ and $\eta'$.
The node $\eta$ is said to satisfy the \emph{pre-regularization unifiability property} in the proof $\psi$ if all elements in $\mathcal{R}(\eta)\cup\{\ell_2\}$ are unifiable.
\end{definition}

\noindent
This property states that a node satisfies the pre-regularization unifibaility property if, for a safe resolved literal $\ell'$ which is resolved against literals $\ell_1$, \ldots, $\ell_n$ in a proof $\psi$, $\ell_1$,\ldots,$\ell_n$, and $\dual{\ell'}$ are unifiable.

One way to ensure this property is met is to slightly modify the notion of safe literals, by applying the unifier of the resolution step to the each pivot before adding it to the set of safe literals (cf. algorithm 3, lines 8 and 10). In the case of Example \ref{ex:pairwise}, this would result in $\eta_3$ having the safe literals $\{q(c),~p(a,b)\}$, where clearly the pivot $p(a,c)$ in $\eta_1$ is not safe.


%extra check example
\begin{example}\label{ex:unifcheck}


Satisfying the pre-regularization unifiability property is not sufficient. Consider the proof $\psi$ in Figure \ref{fig:ex-unifcheck}. After collecting the safe literals, $\eta_3$'s safe literals are $\{\lnot q(T,V),\lnot p(c,d), q(f(a,e),c)\}$.
%\noindent
$\eta_3$'s pivot $q(f(a,V),U)$ is unifiable to (and even more general than) the safe literal $q(f(a,e),c)$. Attempting to regularize $\eta_3$ would lead to the removal of $\eta_2$, the replacement of $\eta_3$ by $\eta_1$ and the removal of $\eta_4$ (because $\eta_1$ does not contain the pivot required by $\eta_5$), with $\eta_5$ also being replaced by $\eta_1$. Then resolution between $\eta_1$ and $\eta_6$ results in $\eta_7'$, which cannot be resolved with $\eta_8$, as shown below.


\begin{scriptsize}
\begin{prooftree}
\def\e{\mbox{\ $\vdash$\ }}
\AxiomC{$\eta_8$: $q(f(a,e),c)\e$ \hspace{-0.5cm}}
\AxiomC{$\eta_6$: $\e p(c,d)$}
\AxiomC{$\eta_1$: $p(U,V)\e q(f(a,V),U)$}
\BinaryInfC{$\eta_7'$: $\e q(f(a,d),c)$}
\BinaryInfC{$\psi'$: ??}
\end{prooftree}
\end{scriptsize}

\noindent
$\eta_1$'s literal $q(f(a, V), U)$, which would be resolved with $\eta_8$'s literal, was changed to $q(f(a,d),c)$ due to the resolution between $\eta_1$ and $\eta_6$.
\end{example}



%ToDo: The following paragraph is not understandable. It must be made clearer. It must be made more formal (as a definition) and more mathematically precise (with the same level of detail as definition 2). It must explain \textbf{why} this additional check suffices.

\noindent
Thus we additionally require that the following property be satisfied.
\begin{definition}
\label{prop:extracheck}
Let $\eta$ be a node satisfying the pre-regularization unifiability property, with safe literals $\mathcal{S}(\eta)$ and parents $\eta_1$ and $\eta_2$, assuming without loss of generality that
%without loss generality 
$\eta_2 \xrightarrow[\sigma_2]{\{\ell_2\} } \eta$ and $\dual{\ell_2} = \ell_1 \in \mathcal{S}(\eta)$. 
%TODO \marginpar{explain, mathematically, what is assumed about $\eta_2$ and $\ell_2$ here}  %Done? This used to say that $\eta_2$ was a deleted node, so that must mean that $\eta_1$ contains the resolved literal that is safe, i.e. $\eta_1$ contains $\ell_1 \in \mathcal{S}(\eta)$, and we have that $\ell_1 = \dual{\ell_2}$
%is marked as a \texttt{deletedNode}
%in a proof $\psi$
The node $\eta$ is said to satisfy the \emph{regularization unifiability property} in $\psi$ if there exists a substitution $\sigma$ such that $\eta_1\sigma \subseteq \mathcal{S}(\eta)$.
\end{definition}
%we ensure that the replacement parent is (possibly after unification) contained entirely in the safe literals. 
This property ensures that the remainder of the proof does not expect a variable in $\eta_1$ to be unified to different values simultaneously. This property is not necessary in the propositional case, as the replacement node would not change lower in the proof. 


%In order to avoid these scenarios, we perform an additional check during inference removal. The node $\eta*$ which will replace a resolution $\eta$ (because $\eta$ would have a deleted parent), must be entirely contained, via unification which modifies only $\eta^*$'s variables, in the safe literals of $\eta$. 
%%In this example, $\eta_1$ does not satisfy this property: in order to unify with $\eta_3$'s safe literals, it would be necessary to send $V\rightarrow Z$ due to $\eta_1$'s second literal, but leave $V$ unchanged due $\eta_1$'s first literal, which is not possible. This check is not necessary in the propositional case, as the replacement node would be contained exactly in the set of safe literals, and would not change lower in the proof.
%In this example, $\eta_1$ does not satisfy this property. This check is not necessary in the propositional case, as the replacement node would be contained exactly in the set of safe literals, and would not change lower in the proof.



An alternative to the regularization property may also be useful for proof compression in some cases. This alternative relies on knowledge of how literals are changed after the deletion of a node in a proof (similar to the \emph{post-deletion unifiability} property observed for {\FOLowerUnits} in \cite{GFOLU}).  
\begin{definition}\label{def:postdelprop}
Let $\eta_1$ be a node with safe literals $\mathcal{S}(\eta)$ such that there exists nodes $\eta_2$ and $\eta$ and resolved literal $\ell'$ such that $\eta_1 \xrightarrow[\sigma']{\{\ell'\} } \eta$ and $\eta_2 \xrightarrow[\sigma'']{\{\dual{\ell'}\} } \eta$.
For each literal $\ell \in \mathcal{S}(\eta_1)$, let $\eta_\ell$ be the lowest node on the path from $\eta_1$ to the root of the proof such that $\ell$ is used as the pivot. % (i.e. $\eta_\ell$ is the node below $\eta$ such that $\ell$ does not appear as a safe literal for any literal between $\eta_\ell$ and the root).
Let $\mathcal{R}(\eta_\ell)$ be the set of all resolved literals $\dual{\ell}$ such that $\eta_2' \xrightarrow[\sigma_2]{\{\ell\} } \eta_\ell$ and $\eta_1' \xrightarrow[\sigma_1]{\{\dual{\ell}\} } \eta_\ell$ for some nodes $\eta_2'$ and $\eta'$.
The node $\eta_1$ is said to satisfy the \emph{post-deletion unifiability property} in $\psi$ if, for all $\ell \in \mathcal{S}(\eta_1)$, all elements in $\mathcal{R}^{\dagger}(\eta_\ell) \cup \{\ell^{\dagger}\}$ are unifiable, where $\ell^{\dagger}$ is the literal in $\dn{\psi}{\eta_2}$ corresponding to $\ell$ in $\psi$ and $\mathcal{R}^{\dagger}(\eta_\ell)$ is the set of literals in $\dn{\psi}{\eta_2}$ corresponding to literals of $\mathcal{R}(\eta_\ell)$ in $\psi$.
\end{definition}


%old
%Let $\mathcal{R}(\eta)$ be the set of resolved literals $\dual{\ell_2}$ contained in some conclusion of a node in $\mathcal{P}(\eta)$.
%Let $\eta$ be a node with safe literals $\mathcal{S}(\eta)$. Consider $p\in \mathcal{S}(\eta)$ and let $\eta_1$, \ldots, $\eta_n$ be subproofs that are resolved using $p$ in a proof $\psi$, respectively, with resolved literals $\ell_1$, \ldots, $\ell_m$. 
%The node $\eta$ is said to satisfy the \emph{post-deletion unifiability property} in $\psi$ if, for all $p\in \mathcal{S}(\eta)$, $\ell_1^{\dagger}$,\ldots,$\ell_m^{\dagger}$, and $\dual{p^{\dagger}}$ are unifiable, where $\ell^{\dagger}$ is the literal in $\dn{\psi}{\eta}$ corresponding to $\ell$ in $\psi$.

Informally, a node $\eta$ satisfies the \emph{post-deletion unifiability property} in a proof if it is the parent of a resolution and we can delete the opposite parent of that same resolution, replacing the resolution node with the initial node such that all of its safe literals can still be used as pivots in order to complete the proof.

\begin{example}
This example illustrates the usefulness of the post-deletion unifiability property as an alternative to the regularization property. In the proof below, note that $\eta_8$ does not satisfy the regularization property: there is no unifier $\sigma$ such that $\sigma \eta_8 \subseteq \mathcal{S}(\eta_8)$ (where $\mathcal{S}(\eta_8) =\{\lnot q(Y),\lnot r(Z),\lnot p(W)\}$).
\begin{scriptsize}
\begin{prooftree}
\def\e{\mbox{\ $\vdash$\ }}
\AxiomC{$\eta_1$: $\e p(U)$ \hspace{-2cm}}
\AxiomC{$\eta_5$: $p(Z) \e q(Z)$ \hspace{-0.5cm}}
\AxiomC{$\eta_8$: $p(X),q(X),r(X)\e$}
\AxiomC{$\eta_7$: $\e p(Y)$  \hspace{-1cm}}
\BinaryInfC{$\eta_6$: $q(Y),r(Y)\e$ }
\BinaryInfC{$\eta_4$: $p(Z),r(Z)\e$ \hspace{-2cm} }
\AxiomC{ \hspace{-1cm} $\eta_3$: $\e r(W)$}
\BinaryInfC{ $\eta_2$: $p(W)\e$}

\BinaryInfC{$\psi$: $\bot$}
\end{prooftree}

\end{scriptsize}
\noindent
We show that this proof satisfies the requirements of the post-deletion unifiability property, and that $\eta_7$ can be removed. To do this, first observe that $\eta_8$ satisfies the pre-regularization unifiability property, since $\lnot  p(X)\in \eta_8$ is in $\mathcal{S}(\eta_8)$. Consider the following proof of $\psi \setminus \{\eta_7\}$:
\begin{scriptsize}
\begin{prooftree}
\def\e{\mbox{\ $\vdash$\ }}
\AxiomC{$\eta_1$: $\e p(U)$ \hspace{-1.75cm}}
\AxiomC{$\eta_8$: $p(X),q(X),r(X)\e$}
\AxiomC{$\eta_5$: $p(Z) \e q(Z)$}
\BinaryInfC{$\eta_4'$: $p(Z), p(Z),r(Z)\e$}
\UnaryInfC{$\eta_4$: $p(Z),r(Z)\e$}
\AxiomC{$\eta_3$: $\e r(W)$}
\BinaryInfC{$\eta_2$: $p(W)\e$}
\BinaryInfC{$\psi$: $\bot$}
\end{prooftree}
\end{scriptsize}
Now observe that for each $\ell \in \mathcal{S}(\eta_8)=\{\lnot  q(Y), \lnot r(Z), \lnot p(W)\}$, the post-deletion unifiability property is satisfied:
\begin{itemize}
\item $\ell=\lnot  q(Y)$: $\ell^\dagger = \lnot q(X)$ which is unifiable with $\dual{\ell}^\dagger=q(Z)$
\item $\ell=\lnot r(Z)$: $\ell^\dagger = \lnot r(Z)$ which is unifiable with $\dual{\ell}^\dagger=r(W)$
\item $\ell=\lnot p(W)$: $\ell^\dagger = \lnot p(W)$ which is unifiable with $\dual{\ell}^\dagger=p(U)$
\end{itemize}
\end{example}

The post-deletion unifiability property is implied by the previous two properties, as shown in the next theorem.

\begin{thm}
Let $\eta$ be a node with parents $\eta_1$ and $\eta_2$ in some proof that satisfies the pre-regularization and regularization unifiability properties. Then one of $\eta_1$ and $\eta_2$ satisfies the post-deletion unifiability property.
\end{thm}

\begin{proof}
Let $\eta$ be a node that satisfies the pre-regularization and regularization unifiability properties with parents $\eta_1$ and $\eta_2$.
%, and is such that  there exists nodes $\eta_1$ and $\eta_2$ and resolved literal $\ell'$ such that $\eta_1 \xrightarrow[\sigma']{\{\ell'\} } \eta$ and $\eta_2 \xrightarrow[\sigma'']{\{\dual{\ell'}\} } \eta$. 
Assume without loss of generality that $\eta_1\sigma \subseteq \mathcal{S}(\eta)$.


Let $\ell \in \mathcal{S}(\eta_1)$ be a safe literal of $\eta_1$, and let $\eta_\ell$ be the lowest node on the path from $\eta_1$ to the root of the proof such that $\ell$ is used as the pivot.
Let $\mathcal{R}(\eta_\ell)$ be the set of all resolved literals $\dual{\ell}$ such that $\eta_2' \xrightarrow[\sigma_2]{\{\ell\} } \eta_\ell$ and $\eta_1' \xrightarrow[\sigma_1]{\{\dual{\ell}\} } \eta_\ell$ for some nodes $\eta_1'$ and $\eta_2'$. Let $\mathcal{R}^\dagger(\eta_\ell)$ be defined as in Definition \ref{def:postdelprop}.
Consider $\dual{\ell} \in \mathcal{R}(\eta_\ell)$: $\ell$ and $\dual{\ell}$ are unifiable in $\psi$. We will show that $\ell^\dagger$ and $\dual{\ell}^\dagger$ are unifiable in $\psi\setminus\{\eta_2\}$ (note that $\dual{\ell}^\dagger\in \mathcal{R}^\dagger(\eta_\ell)$). 


Let $\sigma_0$ be a most general unifier of $\ell$ and $\dual{\ell}$ in $\psi$ (note that $\sigma_0$ exists since $\eta$ satisfies the pre-regularization property).
If $\dual{\ell}\notin \eta_2$ (i.e. $\dual{\ell}$ was in some node $\eta_2\neq \eta_2'$), then we are done, as removing $\eta_2$ does not apply a substitution to $\eta_1$, and thus $\ell^\dagger = \ell$ and $\dual{\ell}^\dagger=\dual{\ell}$, so that $\ell^\dagger$ and $\dual{\ell}^\dagger$ are unifiable with $\sigma_0$.

Thus we may assume that $\dual{\ell}\in \eta_2$. Recall that $\eta$ satisfies the regularization property and by assumption, $\sigma\eta_1\subseteq \mathcal{S}(\eta)$. Therefore there exists some literal $\dual{\ell}'$ below $\eta$ unifiable with $\ell$, as otherwise $\ell \notin \mathcal{S}(\eta)$ (in particular, the resolved literal of node $\eta_\ell$). Note that $\dual{\ell}'=\dual{\ell}^\dagger$ as it corresponds to the opposite literal of $\ell$ in $\psi \setminus \{\eta_2\}$.  Furthermore, as $\dual{\ell}'$ is in $\psi$, $\dual{\ell}'\in \mathcal{R}(\eta)$. Thus, since $\eta$ satisfies the pre-regularization property $\dual{\ell}'$ is unifiable with $\dual{\ell}$ by some $\sigma'$. Thus $\sigma'\dual{\ell}'=\dual{\ell}$, and we have that $\sigma_0\ell = \sigma'\dual{\ell}'=\sigma'\dual{\ell}^\dagger$ so that $\sigma'\sigma_0\ell = \dual{\ell}^\dagger$, as required.

\end{proof}


%intersection example?